{% extends "base.html" %}
{% set current_section = "revenue" %}

{% block title %}Settled by Source – Parking Division{% endblock %}

{% block head_extra %}
<style>
    .card { background: white; padding: 20px; border-radius: 12px; max-width: 1200px; margin: 0 auto; box-shadow: 0 2px 8px rgba(0,0,0,0.07); }
    h2 { font-size: 1.3rem; color: #1e2a3a; margin-bottom: 6px; }
    .back-link { font-size: 0.875rem; color: #2563eb; text-decoration: none; display: inline-block; margin-bottom: 12px; }
    .back-link:hover { text-decoration: underline; }
    table { width: 100%; border-collapse: collapse; margin-top: 12px; }
    th, td { padding: 8px 10px; border-bottom: 1px solid #e6edf2; text-align: center; }
    thead th { background: #f8fafc; font-weight: 700; }
    .cell-0 { background: #fee2e2; color: #9b1c1c; }
    .cell-pos { background: #d1fae5; color: #065f46; }
    .controls { display: flex; gap: 12px; align-items: center; }
    input[type=date] { padding: 8px; border-radius: 6px; border: 1px solid #e5e7eb; }
    button { background: #2563eb; color: white; padding: 8px 12px; border-radius: 6px; border: none; cursor: pointer; }
    button:hover { background: #1d4ed8; }
    .note { color: #6b7280; font-size: 0.875rem; }
</style>
{% endblock %}

{% block content %}
<div class="card">
    <a class="back-link" href="/revenue/reports">← Back to Reports</a>
    <h2>Settled Transactions by Source</h2>
    <div class="note">Daily counts of settled transactions pivoted by source.</div>

    <div style="height:12px"></div>

    <div class="controls">
        <div><label>Start</label><br><input id="startDate" type="date" /></div>
        <div><label>End</label><br><input id="endDate" type="date" /></div>
        <div><label>&nbsp;</label><br><button id="run">Run</button></div>
        <div style="margin-left:auto"><span id="status" style="color:#6b7280"></span></div>
    </div>

    <div id="tableContainer"></div>
</div>
{% endblock %}

{% block scripts %}
<script>
    const token = localStorage.getItem('access_token');

    (function setDefaultDates(){
        const today = new Date();
        const end = new Date(today); end.setDate(end.getDate() - 1);
        const start = new Date(today); start.setDate(start.getDate() - 30);
        const asDate = d => d.toISOString().split('T')[0];
        document.getElementById('startDate').value = asDate(start);
        document.getElementById('endDate').value = asDate(end);
    })();

    document.getElementById('run').addEventListener('click', async () => {
        const s = document.getElementById('startDate').value;
        const e = document.getElementById('endDate').value;
        if (!s || !e) { alert('Select start and end dates'); return; }

        document.getElementById('status').textContent = 'Loading...';
        const resp = await fetch(`/api/v1/reports/verify?start_date=${encodeURIComponent(s)}&end_date=${encodeURIComponent(e)}`, {
            headers: { 'Authorization': `Bearer ${token}` }
        });
        if (!resp.ok) {
            const text = await resp.text();
            alert('Error: ' + text);
            document.getElementById('status').textContent = '';
            return;
        }
        const data = await resp.json();
        renderTable(data);
        document.getElementById('status').textContent = `Rows: ${data.rows.length}`;
    });

    function renderTable(payload) {
        if (!payload.rows || payload.rows.length === 0) {
            document.getElementById('tableContainer').innerHTML = '<div style="padding:18px;color:#6b7280">No rows returned</div>';
            return;
        }
        const cols = Object.keys(payload.rows[0]);
        const head = `<thead><tr>${cols.map(c => `<th>${/date/i.test(c) ? 'Settle Date' : c}</th>`).join('')}</tr></thead>`;
        const body = payload.rows.map(r => `<tr>${cols.map(c => {
            if (/date/i.test(c)) return `<td>${r[c] || ''}</td>`;
            const vnum = r[c] == null ? 0 : Number(r[c]);
            return `<td class="${vnum > 0 ? 'cell-pos' : 'cell-0'}">${vnum}</td>`;
        }).join('')}</tr>`).join('');
        document.getElementById('tableContainer').innerHTML = `<table>${head}<tbody>${body}</tbody></table>`;
    }
</script>
{% endblock %}
