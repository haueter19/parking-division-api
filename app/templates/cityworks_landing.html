{% extends "base.html" %}
{% set current_section = "cityworks" %}

{% block title %}Cityworks – Parking Division{% endblock %}

{% block head_extra %}
<style>
    .section-header {
        display: flex;
        align-items: baseline;
        gap: 16px;
        margin-bottom: 24px;
    }
    .section-header h1 { font-size: 1.5rem; color: #1e2a3a; font-weight: 700; }

    .quick-links {
        display: flex;
        gap: 10px;
        margin-bottom: 28px;
        flex-wrap: wrap;
    }
    .quick-links a {
        background: #d97706;
        color: #fff;
        text-decoration: none;
        padding: 8px 18px;
        border-radius: 6px;
        font-size: 0.875rem;
        font-weight: 600;
        transition: background 0.15s;
    }
    .quick-links a:hover { background: #b45309; }

    /* Stat cards */
    .stats-row {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
        gap: 16px;
        margin-bottom: 28px;
    }
    .stat-card {
        background: #fff;
        border-radius: 10px;
        padding: 20px 22px;
        box-shadow: 0 2px 6px rgba(0,0,0,0.07);
        border-top: 4px solid #d97706;
        text-align: center;
    }
    .stat-card .stat-label {
        font-size: 0.78rem;
        color: #6b7280;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        margin-bottom: 8px;
    }
    .stat-card .stat-value {
        font-size: 2rem;
        font-weight: 700;
        color: #1e2a3a;
        line-height: 1;
    }
    .stat-card .stat-sub {
        font-size: 0.78rem;
        color: #9ca3af;
        margin-top: 6px;
    }
    .stat-card.stat-open { border-top-color: #ef4444; }
    .stat-card.stat-open .stat-value { color: #dc2626; }
    .stat-card.stat-assigned { border-top-color: #f59e0b; }
    .stat-card.stat-closed { border-top-color: #10b981; }
    .stat-card.stat-closed .stat-value { color: #059669; }
    .stat-card.stat-time { border-top-color: #6366f1; }

    .card {
        background: #fff;
        border-radius: 10px;
        padding: 20px 22px;
        box-shadow: 0 2px 6px rgba(0,0,0,0.07);
        margin-bottom: 20px;
    }
    .card h2 {
        font-size: 0.95rem;
        font-weight: 700;
        color: #374151;
        margin-bottom: 14px;
        display: flex;
        align-items: center;
        justify-content: space-between;
    }
    .card h2 a {
        font-size: 0.78rem;
        font-weight: 500;
        color: #2563eb;
        text-decoration: none;
    }
    .card h2 a:hover { text-decoration: underline; }

    .loading { color: #9ca3af; font-size: 0.875rem; padding: 12px 0; }
    .error   { color: #ef4444; font-size: 0.875rem; padding: 12px 0; }

    .section-note {
        background: #fffbeb;
        border-left: 4px solid #f59e0b;
        padding: 12px 16px;
        border-radius: 6px;
        font-size: 0.875rem;
        color: #92400e;
        margin-bottom: 20px;
    }
</style>
{% endblock %}

{% block content %}
<div class="section-header">
    <h1>Cityworks</h1>
</div>

<div class="quick-links">
    <a href="/cityworks/work-orders">Work Orders</a>
</div>

<!-- Stat cards -->
<div class="stats-row" id="statsRow">
    <div class="stat-card stat-open">
        <div class="stat-label">Open Tickets</div>
        <div class="stat-value loading" id="statOpen">—</div>
        <div class="stat-sub">Update GIS (open/hold)</div>
    </div>
    <div class="stat-card stat-assigned">
        <div class="stat-label">Assigned This Week</div>
        <div class="stat-value loading" id="statAssigned">—</div>
        <div class="stat-sub">Last 7 days</div>
    </div>
    <div class="stat-card stat-closed">
        <div class="stat-label">Closed This Week</div>
        <div class="stat-value loading" id="statClosed">—</div>
        <div class="stat-sub">Last 7 days</div>
    </div>
    <div class="stat-card stat-time">
        <div class="stat-label">Avg Days to Close</div>
        <div class="stat-value loading" id="statAvgDays">—</div>
        <div class="stat-sub">Moving avg, last 90 days</div>
    </div>
</div>

<div class="card">
    <h2>Work Orders <a href="/cityworks/work-orders">Open Work Orders →</a></h2>
    <p style="color:#6b7280;font-size:0.875rem">View and process Update GIS work orders from the work orders page.</p>
</div>
{% endblock %}

{% block scripts %}
<script>
const token = localStorage.getItem('access_token');

async function loadStats() {
    try {
        const resp = await fetch('/api/v1/cityworks/stats', {
            headers: { 'Authorization': `Bearer ${token}` }
        });
        if (!resp.ok) {
            const msg = await resp.text();
            ['statOpen','statAssigned','statClosed','statAvgDays'].forEach(id => {
                document.getElementById(id).textContent = 'Error';
                document.getElementById(id).classList.add('error');
            });
            return;
        }
        const s = await resp.json();
        document.getElementById('statOpen').textContent = s.open_count ?? '—';
        document.getElementById('statAssigned').textContent = s.assigned_last_week ?? '—';
        document.getElementById('statClosed').textContent = s.closed_last_week ?? '—';
        document.getElementById('statAvgDays').textContent = s.avg_days_to_complete != null ? s.avg_days_to_complete + 'd' : '—';
    } catch(e) {
        ['statOpen','statAssigned','statClosed','statAvgDays'].forEach(id => {
            document.getElementById(id).textContent = 'Err';
        });
    }
}

loadStats();
</script>
{% endblock %}
